---
title: "Exploratory analysis of archaeological ceramic compositions"
output: 
  html_notebook: 
    toc: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(out.width='750px')
```





## Description
R-Script for the analysis of archaeological ceramics                
License Script: [GPL](http://www.gnu.org/licenses/gpl-3.0.html)

* Exploratory analysis of archaeological ceramic compositions 
* Based on M.J. Baxter and Jaume Buxeda i Garrigos variation matrix
* Using clr transformation for dendrograms with ggbiplot
* Using alr transformation for principal component analysis
* The chemical raw data is shown with the heatmap
* scripts: uniformitat, get_anids and means_sd are used here apart from these packages:


##Data import and cleaning
###Import data from csv

Create a dataframe with the raw data on the csv file. For more details on different formats check [this website](https://rstudio-pubs-static.s3.amazonaws.com/1776_dbaebbdbde8d46e693e5cb60c768ba92.html).
```{r}
df_raw_0 <- read.csv2("data_excel.csv", header =TRUE, row.names=1, sep = ";", dec = ",")
```


###Check if the import is ok. Do we have factors and nummeric data?

```{r}
str(df_raw_0)
```

Check for any negative data.
```{r}
if (min(df_raw_0[,-c(1:9)]) < 0) {
  cat("Negative data - terminating.")
}else {
    cat("All the values are positive!")
}
```



### The number of samples and variables is right?
```{r}
paste (nrow(df_raw_0), "samples in the dataset") #samples go in rows
paste (ncol(df_raw_0), "variables in the dataset") #variables go in columns
```

### Define the data type (nummeric and categorical)

* df_raw_0 will remain untouched
* df_raw is the dataframe we are going to work with
* df_chem contains only the numerical data (requires indicating how many categorical columns we have)

```{r}
df_raw <- df_raw_0  #we are calling to the whole dataset
df_chem <- df_raw_0[,-c(1:9)] #ignore all the columns containing categorical data, 9 in this case. 
x <- df_chem #for working with the functions
y <- df_raw #for working with the functions
```
###Check the structure of the new dataset (skip if desired)
```{r}
str(df_raw)
```
In df_chem only integers (int) and nummerical (num),those are with decimmals 
```{r}
str(df_chem)
```
###Create categories based on the calcium content or any other condition (optional)

A column has to be created before with the desired name. Otherwise, this is added to the dataframe at the last position.
The code scheme is the next:

 "New_category" -> df$Column[matching_condition] 

```{r}

df_raw$Calcareous <- as.character(df_raw$Calcareous) #change from factor to chacter class to modify it
   "Non-Calcareous (<%6CaO)" ->   df_raw$Calcareous[df_raw$CaO < 6]
   "Calcareous (>%6CaO)" ->       df_raw$Calcareous[df_raw$CaO> 6]
   "High Calcareous (>%20CaO)" -> df_raw$Calcareous[df_raw$CaO > 20]
   
df_raw$Calcareous <- as.factor(df_raw$Calcareous)  #bring back to factors
```
We might want to have a glance at how is the calcium content of the samples 
```{r}
library(dplyr)
select(df_raw,c(CaO,Calcareous)) 

```
##Applying statistics to the dataset

###Variation Matrix

Variation matrix to check how the elements are varying among the dataset. 


```{r}
require(compositions) # para transformaciones
require(plotrix) #para boxed labels
require(devEMF)
source('~/Programming/arch_notebook/R_fun/entropia02.R')
source('~/Programming/arch_notebook/R_fun/sum_table.R')
source('~/Programming/arch_notebook/R_fun/etiquetes.elements.R')
source('~/Programming/arch_notebook/R_fun/classifica.R')
source('~/Programming/arch_notebook/R_fun/arch_uniformitat.R')
arch_uniformitat(df_chem)
```
###Cluster Analysis

Create the dendrograms based on the clr data. Required: define x for numerical (df_chem) and y for whole dataset (df_raw_0). If desired the emf and pdf can be directly saved to the local folder turning the argument of arch_dendro = TRUE, by default is false.


```{r}
require(ggbiplot)
require(dendextend)
source('~/Programming/arch_notebook/R_fun/logcenter.tran.R')
source('~/Programming/arch_notebook/R_fun/arch_dendro.R')
arch_dendro(x,printDendro = FALSE, n=9)
```



###Principal Component Analysis (alr)

For the additive log ratio transformation (ALR), we need to assign the less varying element. In this case is 8, as we have seen from applying matrix variation. 
```{r}
library(ggbiplot)
source('~/Programming/arch_notebook/R_fun/arch_PCA.R')
p <- 8
arch_PCA(x,p = 8,n=9)
```

###Heatmap (table with the concentrations)
```{r}
require(d3heatmap)
source('~/Programming/arch_notebook/R_fun/arch_heatmap.R')
arch_heatmap(x)
```

###Summary table for groups with the means and RSD
```{r}
source('~/Programming/arch_notebook/R_fun/sum_table.R')
require(RcmdrMisc)
print(sum_table(x))  # This code is external
print(paste("Includes", nrow(x),"samples"))
print(deparse(substitute(df_raw_0))) #get the name of the df
```

WORKING PROGRESS:

- use the less varying element for the alr in PCAs, return value from the function?
